# Документация по файлу 28.xlsm "Порода по крыльям"

**Версия:** 2.5  
**Автор:** Карташев Анатолий  
**Пароль защиты листов:** `kart95`

---

## 1. СТРУКТУРА КНИГИ

| № | Лист | Строк | Колонок | Назначение |
|---|------|-------|---------|------------|
| 1 | ИД и расчеты | 263 | 20 | Входные данные + расчёт индексов |
| 2 | Индексы | 110 | 11 | Рассчитанные CI, DsA, HI + статистика |
| 3 | Породы | 27 | 23 | Эталонные диапазоны 4 пород |
| 4 | Результаты | 103 | 11 | Идентификация породы |
| 5 | Графики | 39 | 14 | Данные для гистограмм |
| 6-8 | График DsA/CI/HI | 1 | 1 | Гистограммы индексов |
| 9 | Анализ | 130 | 44 | Итоговая оценка с баллами |
| 10 | Что нового | 25 | 22 | История версий |

---

## 2. ВХОДНЫЕ ДАННЫЕ (Лист "ИД и расчеты")

### Формат координат (строки 3-102):

| Колонки | Точка | Описание |
|---------|-------|----------|
| A-B | 1 | X₁, Y₁ |
| C-D | 2 | X₂, Y₂ |
| E-F | 3 | X₃, Y₃ |
| G-H | 4 | X₄, Y₄ |
| I-J | 5 | X₅, Y₅ |
| K-L | 6 | X₆, Y₆ |
| M-N | 7 | X₇, Y₇ |
| O-P | 8 | X₈, Y₈ |
| Q | - | Источник: "TPSDig" или "TpsDig" |

---

## 3. ФОРМУЛЫ РАСЧЁТА ИНДЕКСОВ (Лист "ИД и расчеты", строки 105-204)

### 3.1 Кубитальный индекс (CI) — Колонка B

```
B105 = IF(SQRT((K3-M3)² + (L3-N3)²) > 0,
          SQRT((I3-K3)² + (J3-L3)²) / SQRT((K3-M3)² + (L3-N3)²),
          FALSE)
```

**Расшифровка:**

```
CI = dist(Точка5, Точка6) / dist(Точка6, Точка7)
   = √[(X₅-X₆)² + (Y₅-Y₆)²] / √[(X₆-X₇)² + (Y₆-Y₇)²]
   = отрезок_a / отрезок_b
```

Где:
- Точка 5 (I,J) — начало отрезка a
- Точка 6 (K,L) — конец отрезка a / начало отрезка b  
- Точка 7 (M,N) — конец отрезка b

---

### 3.2 Дискоидальное смещение (DsA) — Колонка C

```
C105 = IF(A3>0,
          IF($Q$1="TPSDig",
             -ATAN((H105-I105)/(1+I105*H105)),
              ATAN((H105-I105)/(1+I105*H105))
          ) * 180/PI(),
          FALSE)
```

**Вспомогательные расчёты:**

**F105** — X-координата точки пересечения (центр):
```
F105 = (D3²×A3 - B3×D3×A3 - D3×A3×F3 - D3×B3×C3 + D3×C3×F3 - B3×C3×F3 + 
        B3²×C3 + E3×C3² + A3²×E3 - 2×C3×E3×A3 + A3×F3×B3) / 
       (C3² - 2×A3×C3 + A3² + D3² - 2×D3×B3 + B3²)
```

**G105** — Y-координата точки пересечения:
```
G105 = (-C3×D3×A3 + B3×C3² + D3×A3² - A3×B3×C3 + D3²×F3 - 2×D3×F3×B3 + 
        B3²×F3 + E3×C3×D3 - E3×B3×C3 - E3×D3×A3 + A3×E3×B3) /
       (C3² - 2×A3×C3 + A3² + D3² - 2×D3×B3 + B3²)
```

**H105** — наклон первой линии:
```
H105 = (G105 - F3) / (F105 - E3)
     = (Yцентр - Y₃) / (Xцентр - X₃)
```

**I105** — наклон второй линии:
```
I105 = (G105 - P3) / (F105 - O3)
     = (Yцентр - Y₈) / (Xцентр - X₈)
```

**Итоговая формула DsA:**
```
DsA = ±arctan[(H105 - I105) / (1 + I105×H105)] × 180/π

Знак зависит от источника:
  TPSDig → отрицательный (умножение на -1)
  WingsDig → положительный
```

**Геометрический смысл:**  
DsA — это угол между двумя прямыми, проходящими через вычисленную точку пересечения и точки 3 и 8 соответственно.

---

### 3.3 Гантельный индекс (HI) — Колонка D

```
D105 = IF(SQRT((E3-G3)² + (F3-H3)²) > 0,
          SQRT((I3-M3)² + (J3-N3)²) / SQRT((E3-G3)² + (F3-H3)²),
          FALSE)
```

**Расшифровка:**
```
HI = dist(Точка5, Точка7) / dist(Точка3, Точка4)
   = √[(X₅-X₇)² + (Y₅-Y₇)²] / √[(X₃-X₄)² + (Y₃-Y₄)²]
```

---

### 3.4 КИ% по Алпатову (Лист "Индексы", колонка E)

```
E2 = IF(A2>0, 1/B2 × (0.0381×B2 + 0.9982), "")
```

**Эквивалент:**
```
КИ% = (0.0381×CI + 0.9982) / CI
    = 0.0381 + 0.9982/CI
```

---

## 4. ЭТАЛОННЫЕ ДИАПАЗОНЫ ПОРОД (Лист "Породы")

| Порода | CI min | CI max | DsA min | DsA max | HI min | HI max |
|--------|--------|--------|---------|---------|--------|--------|
| Mellifera | 0.76 | 2.16 | -15.31 | **0.00** | 0.616 | 0.923 |
| Caucasica | 1.73 | 2.75 | -2.84 | 2.84 | 0.704 | 1.027 |
| Ligustica | 2.00 | 3.29 | 0.00 | 4.73 | 0.923 | 1.206 |
| Carnica | 2.16 | 5.67 | 0.00 | 12.39 | 0.923 | 1.420 |

**⚠️ ВАЖНО:** Диапазоны пересекаются — крыло может быть отнесено к нескольким породам.

---

## 5. ИДЕНТИФИКАЦИЯ ПОРОДЫ (Лист "Результаты")

### Формула идентификации (пример для Mellifera, ячейка B3):

```
B3 = IF(AND(
        Индексы!B2 >= Породы!$C$4,    // CI >= 0.76
        Индексы!B2 <= Породы!$D$4,    // CI <= 2.16
        Индексы!C2 >= Породы!$E$4,    // DsA >= -15.31
        Индексы!C2 <= Породы!$F$4,    // DsA <= 0
        Индексы!D2 >= Породы!$G$4,    // HI >= 0.616
        Индексы!D2 <= Породы!$H$4     // HI <= 0.923
     ),
     IF(Индексы!B2 > 0, Породы!$B$4, " "),  // "Mellifera"
     " ")
```

**Псевдокод:**
```python
def identify_breed(CI, DsA, HI, breed_ranges):
    for breed in ['Mellifera', 'Caucasica', 'Ligustica', 'Carnica']:
        if (breed.CI_min <= CI <= breed.CI_max and
            breed.DsA_min <= DsA <= breed.DsA_max and
            breed.HI_min <= HI <= breed.HI_max):
            return breed.name
    return " "  # Не идентифицировано
```

---

## 6. СТАТИСТИКА (Лист "Индексы", строки 102-109)

| Строка | Показатель | Формула CI (B) | Формула DsA (C) | Формула HI (D) |
|--------|------------|----------------|-----------------|----------------|
| 102 | МО (среднее) | `=AVERAGE($B$2:$B$101)` | `=AVERAGE($C$2:$C$101)` | `=AVERAGE($D$2:$D$101)` |
| 103 | СКО (ст.откл.) | `=ROUND(STDEV(B2:B101),3)` | `=ROUND(STDEV(C2:C101),3)` | `=ROUND(STDEV(D2:D101),3)` |
| 104 | Квар (коэф.вар.) | `=ROUND(B103/B102,3)` | `=ABS(ROUND(C103/C102,3))` | `=ROUND(D103/D102,3)` |
| 105 | MIN | `=MIN(B2:B101)` | `=MIN(C2:C101)` | `=MIN(D2:D101)` |
| 106 | MAX | `=MAX(B2:B101)` | `=MAX(C2:C101)` | `=MAX(D2:D101)` |
| 108 | 95% ДИ min | `=B102 - B103×1.96` | `=C102 - C103×1.96` | `=D102 - D103×1.96` |
| 109 | 95% ДИ max | `=B102 + B103×1.96` | `=C102 + C103×1.96` | `=D102 + D103×1.96` |

---

## 7. ЛИСТ "АНАЛИЗ" — ПОДРОБНЫЙ РАЗБОР ФОРМУЛ

### 7.1 Количество исследованных крыльев (C3)

```
C3 = COUNTIF(Индексы!$B$2:$B$101, ">0")
```
Подсчитывает крылья с рассчитанным CI > 0.

---

### 7.2 Неидентифицированные крылья (C4, D4)

**Количество (доля):**
```
C4 = P7 / C3

Где P7 = SUM(Q1:Q106) — сумма индикаторов неидентифицированных крыльев
```

**Индикатор неидентифицированного крыла (Q1-Q106):**
```
Q1 = IF(AND(
        Индексы!B2,                      // CI существует
        Результаты!B3 = " ",             // Не Mellifera
        Результаты!C3 = " ",             // Не Caucasica
        Результаты!D3 = " ",             // Не Ligustica
        Результаты!E3 = " "              // Не Carnica
     ), 1, 0)
```

**Баллы:**
```
D4 = -ROUND(C4 / 5%, 0)
```
Штраф: **-1 балл за каждые 5%** неидентифицированных крыльев.

---

### 7.3 Морфометрические показатели (C6-C8)

**Кубитальный индекс с ошибкой (C6):**
```
C6 = TEXT(Индексы!B102, "0,000") & " ± " & 
     TEXT(ROUND(Индексы!B103, 3) / POWER(C3, 0.5), "0,000")
```
Формат: `МО ± СКО/√n` (стандартная ошибка среднего)

**С КИ% по Алпатову (E6):**
```
E6 = ROUND(Индексы!E102×100, 1) & " ± " & 
     ROUND(ROUND(Индексы!E103×100, 1) / POWER(C3, 0.5), 2) & "% по Алпатову"
```

---

### 7.4 Превалирующая порода (C14)

```
C14 = IF(Результаты!K23 = MAX(Результаты!K23:K26), Результаты!H23,
      IF(Результаты!K24 = MAX(Результаты!K23:K26), Результаты!H24,
      IF(Результаты!K25 = MAX(Результаты!K23:K26), Результаты!H25,
                                                    Результаты!H26)))
```
Выбирает породу с максимальной прогнозной вероятностью (K23:K26).

---

### 7.5 Вероятностная оценка соответствия (C15, D15)

**Значение:**
```
C15 = ROUND(IF(Результаты!I23 = MAX(I23:I26), K23, ...), 3)
```
Прогнозная вероятность для породы с максимальным количеством позиций.

**Баллы:**
```
D15 = 5 + ROUNDUP((C15 - 100%) / 10%, 0)
```
- **5 баллов** за 100%
- **-1 балл** за каждые 10% снижения

---

### 7.6 Целостность семьи (C17, D17, C19, D19)

**По кубитальному индексу:**
```
C17 = IF(Индексы!B104 < 12.5%, "идеальная",
      IF(Индексы!B104 > 20%, "не обеспечена", "нормальная"))

D17 = IF(C17 = "идеальная", 2, IF(C17 = "нормальная", 1, 0))
```

| Квар CI | Оценка | Баллы |
|---------|--------|-------|
| < 12.5% | идеальная | 2 |
| 12.5-20% | нормальная | 1 |
| > 20% | не обеспечена | 0 |

**По гантельному индексу:**
```
C19 = IF(Индексы!D104 < 6.5%, "идеальная",
      IF(Индексы!D104 > 7.5%, "не обеспечена", "нормальная"))

D19 = IF(C19 = "идеальная", 2, IF(C19 = "нормальная", 1, 0))
```

| Квар HI | Оценка | Баллы |
|---------|--------|-------|
| < 6.5% | идеальная | 2 |
| 6.5-7.5% | нормальная | 1 |
| > 7.5% | не обеспечена | 0 |

**По DsA:** не анализируется (МО может быть близко к нулю).

---

### 7.7 Степень гибридизации (C21-C23, D21-D23)

#### Определение номера превалирующей породы:
```
R25 = MATCH(C14, Результаты!H23:H26, 0)
```

#### Алгоритм расчёта (на примере CI, строка 29):

**1. Находим границы породных диапазонов:**
```
R30 = MATCH(Породы!D4, Графики!$B$1:$B$30, 1) - 1  // Верх диапазона Mellifera
R32 = MATCH(Породы!C4, Графики!$B$1:$B$30, 1) - 1  // Низ диапазона Mellifera
```

**2. Считаем крылья в критических диапазонах:**

*Второго ранга (R34):*
```
R34 = SUM(OFFSET(Графики!$C$1, R30+3, 0) : OFFSET(Графики!$C$1, 30, 0))
```
Сумма крыльев выше верхней границы +3 класса.

*Первого ранга (R35):*
```
R35 = SUM(OFFSET(Графики!$C$1, R30, 0) : OFFSET(Графики!$C$1, R30+2, 0))
```
Сумма крыльев в 3 классах около границы.

**3. Вычисляем проценты:**
```
R27 = R34 / C3 × 100  // % в критических 2-го ранга (допуск 2%)
R28 = R35 / C3 × 100  // % в критических 1-го ранга (допуск 15%)
```

**4. Определяем степень гибридизации:**
```
R29 = IF(OR(R27 > 2, R28 > 15), "Гибрид",
      IF(OR(R27 > 1, R28 > 7.5), "В допустимых пределах",
      IF(OR(R27 > 0, R28 > 0), "Несущественная", "Отсутствует")))
```

**5. Выбираем результат для превалирующей породы:**
```
C21 = OFFSET(Q29, 0, R25 + IF(R25>2,1,0) + IF(R25>3,1,0))
```

**6. Начисляем баллы:**
```
D21 = IF(C21 = "Отсутствует", 3,
      IF(C21 = "Несущественная", 2,
      IF(C21 = "В допустимых пределах", 1, 0)))
```

| Степень гибридизации | Баллы |
|---------------------|-------|
| Отсутствует | 3 |
| Несущественная | 2 |
| В допустимых пределах | 1 |
| Гибрид | 0 |

---

### 7.8 Пороги гибридизации

| Диапазон | Критерий | Результат |
|----------|----------|-----------|
| 2-го ранга > 2% **ИЛИ** 1-го ранга > 15% | Гибрид |
| 2-го ранга > 1% **ИЛИ** 1-го ранга > 7.5% | В допустимых пределах |
| 2-го ранга > 0% **ИЛИ** 1-го ранга > 0% | Несущественная |
| Оба = 0% | Отсутствует |

---

### 7.9 Итоговое количество баллов (D24)

```
D24 = SUM(D4:D23)
```

Суммирует баллы:
- D4: Неидентифицированные крылья
- D15: Соответствие породе
- D17: Целостность по CI
- D19: Целостность по HI
- D21: Гибридизация по CI
- D22: Гибридизация по DsA
- D23: Гибридизация по HI

---

### 7.10 Пригодность семьи (C26-C29)

```
C26 = IF(D24 >= 17, "пригодна", "не пригодна")  // Родоначальница линии
C27 = IF(D24 >= 15, "пригодна", "не пригодна")  // Репродуктор маток
C28 = IF(D24 >= 10, "пригодна", "не пригодна")  // Дальнейшая селекция
C29 = IF(D24 >= 5, "пригодна", "не пригодна")   // Вывод маток для себя
```

| Уровень | Мин. баллов | Назначение |
|---------|-------------|------------|
| ≥17 | 17 | Родоначальница линии |
| ≥15 | 15 | Репродуктор маток |
| ≥10 | 10 | Дальнейшая селекция |
| ≥5 | 5 | Вывод маток для себя |

---

## 8. VBA МАКРОСЫ

### 8.1 Макрос3 (Ctrl+T) — Импорт TPS

**Назначение:** Импорт из TpsDig (.tps)

**Алгоритм:**
1. Запрос подтверждения
2. Установка `Q1 = "TPSDig"` (влияет на знак DsA)
3. Открытие файла .tps (кодировка 866, разделитель — пробел)
4. Проверка кратности 8 точек
5. Реорганизация: 8 строк → 1 строка (16 колонок X,Y)
6. Копирование в "ИД и расчеты" (A3:P102)
7. Копирование расчётов (A105:D204) → "Индексы" (A2:D101)

**Ключевой код преобразования:**
```vba
For i = 1 To k / 8
    For j = 1 To 8
        ' Вырезаем строку j точки i-го крыла
        Range(Cells(i * 8 - 7 + j + L * 8, 1), 
              Cells(i * 8 - 7 + j + L * 8, 2)).Cut
        ' Вставляем в колонки (j-1)*2+1 и (j-1)*2+2
        Range(Cells(i + 1 + L, (j - 1) * 2 + 1), 
              Cells(i + 1 + L, (j - 1) * 2 + 2)).Select
        ActiveSheet.Paste
    Next j
Next i
```

---

### 8.2 Макрос1 (Ctrl+B) — Импорт WingsDig

**Назначение:** Импорт из WingsDig (.tps)

Аналогичен Макрос3, но устанавливает `Q1 = "TpsDig"`.

**Различие:** Знак DsA положительный (без инверсии).

---

### 8.3 Worksheet_Activate (Листы 8, 9, 10)

**Назначение:** Автомасштабирование графиков

```vba
Private Sub Worksheet_Activate()
    With Me
        If .ChartObjects("Диаграмма 1099").Chart.Axes(xlValue).MaximumScale <> _
           .Cells(1, 1).Value Then
            .Unprotect("kart95")
            .ChartObjects("Диаграмма 1099").Chart.Axes(xlValue).MaximumScale = _
               .Cells(1, 1).Value
            .Protect("kart95")
        End If
    End With
End Sub
```

---

## 9. ПРОГНОЗНАЯ ВЕРОЯТНОСТНАЯ ОЦЕНКА (Лист "Результаты", K23-K26)

### Формула для Mellifera (K23):

```
K23 = IF(AND(Индексы!B109 >= Породы!C4, Индексы!B108 <= Породы!D4),
          (IF(B109 >= D4, D4, B109) - IF(B108 >= C4, B108, C4)), 0)
      ×
      IF(AND(C109 >= E4, C108 <= F4),
          (IF(C109 >= F4, F4, C109) - IF(C108 >= E4, C108, E4)), 0)
      ×
      IF(AND(D109 >= G4, D108 <= H4),
          (IF(D109 >= H4, H4, D109) - IF(D108 >= G4, D108, G4)), 0)
      /
      ((B109 - B108) × (C109 - C108) × (D109 - D108))
```

**Геометрический смысл:**

Это отношение объёма **пересечения** 3D-прямоугольника выборки (95% ДИ) с 3D-прямоугольником породы к объёму прямоугольника выборки.

```
Прогноз = (ΔCI_пересечение × ΔDsA_пересечение × ΔHI_пересечение) / 
          (ΔCI_выборки × ΔDsA_выборки × ΔHI_выборки)
```

---

## 10. СООТВЕТСТВИЕ ТОЧЕК

### Нумерация WingsDig/TpsDig → Формулы:

| Точка | Колонки | Используется в |
|-------|---------|----------------|
| 1 | A, B | F105, G105 (центр) |
| 2 | C, D | F105, G105 (центр) |
| 3 | E, F | H105 (наклон 1), HI |
| 4 | G, H | HI |
| 5 | I, J | CI, HI |
| 6 | K, L | CI |
| 7 | M, N | CI, HI |
| 8 | O, P | I105 (наклон 2) |

---

## 11. PYTHON-РЕАЛИЗАЦИЯ

```python
import numpy as np

def calc_indices(pts):
    """
    pts: list of 8 points [(x1,y1), ..., (x8,y8)]
    Returns: dict with CI, DsA, HI
    """
    def dist(p1, p2):
        return np.sqrt((p2[0]-p1[0])**2 + (p2[1]-p1[1])**2)
    
    # CI = dist(5,6) / dist(6,7)
    CI = dist(pts[4], pts[5]) / dist(pts[5], pts[6])
    
    # HI = dist(5,7) / dist(3,4)
    HI = dist(pts[4], pts[6]) / dist(pts[2], pts[3])
    
    # DsA - угол между двумя прямыми через центр
    x1, y1 = pts[0]  # Точка 1
    x2, y2 = pts[1]  # Точка 2
    x3, y3 = pts[2]  # Точка 3
    x8, y8 = pts[7]  # Точка 8
    
    # Знаменатель для центра
    denom = (x3-x1)**2 + (y2-y4)**2
    
    # Координаты центра (сложная формула из Excel)
    # ... (см. F105, G105)
    
    # Наклоны
    # k1 = (Yc - y3) / (Xc - x3)
    # k2 = (Yc - y8) / (Xc - x8)
    
    # DsA = arctan((k1 - k2) / (1 + k1*k2)) * 180 / pi
    # Знак: отрицательный для TPSDig
    
    return {'CI': CI, 'DsA': DsA, 'HI': HI}


def identify_breed(CI, DsA, HI):
    """Идентификация породы по индексам."""
    breeds = {
        'Mellifera':  {'CI': (0.76, 2.16), 'DsA': (-15.31, 0), 'HI': (0.616, 0.923)},
        'Caucasica':  {'CI': (1.73, 2.75), 'DsA': (-2.84, 2.84), 'HI': (0.704, 1.027)},
        'Ligustica':  {'CI': (2.00, 3.29), 'DsA': (0, 4.73), 'HI': (0.923, 1.206)},
        'Carnica':    {'CI': (2.16, 5.67), 'DsA': (0, 12.39), 'HI': (0.923, 1.420)},
    }
    
    result = []
    for name, rng in breeds.items():
        if (rng['CI'][0] <= CI <= rng['CI'][1] and
            rng['DsA'][0] <= DsA <= rng['DsA'][1] and
            rng['HI'][0] <= HI <= rng['HI'][1]):
            result.append(name)
    
    return result if result else ['Не идентифицировано']
```

---

*Документ создан на основе анализа файла 28.xlsm*
